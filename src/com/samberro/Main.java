package com.samberro;

import com.samberro.matcher.MatchInfo;
import com.samberro.matcher.Matcher;

import java.io.*;

import static com.samberro.utils.Utils.*;

public class Main {

    public static void main(String[] args) throws IOException {
        byte[] bytes = fromByteString("78682354D0B2416927E039FF9438D6E9C396A8FC2AB10E7A02AB9C3288B93CD911E80D55E21C088A296AA1B144C28E5576596A0AAC342FC7C85D67107029D60D5D4E88FDD3BB5CAC5865314C94DDFADD8173F5B33DC692950D4C83C6991F1D867CF4EAEE97F8D8952CB46A8F5D5C1BA0D3D1469BA625CC8759A2CBE6E712A4CFCA90B9EEC65B35633227DFFE06098F34605DA9CB110488D2CBB64B0352E804272D4A6067C0E63403E3A26F5FD879C5221EE11D2FB7FE56BFD825C8380157B3FF35F3FFE85A4089BAC9B94F3D5F4A8466D0C44A171416402C58584EA27C03E8801797F8A2249700A0FAF44A68E36CBFF0A0662BB6B3A3580CE44C90E1E523BE0266C2DCEB335BC820D9445573EB8569258B1D26A687107DE286BEF39C45BF4596AA319BBF8731127A2E546535D183CD5E962E4763D0CDAB4ABA0245FAE7D9BC7EC5CFF73AF8C2F24190B7F44966E43667E03E1ECB95527271B538EF29C9205AAF202EE01FB748E4DE1633478EA85A2A02780C23A4AF1F52980BA474DA11E61356B2E0C25460F8F00B6490C7A786C63462077895165E0C02949A4CA3C3A3809650CF67D4649AB12B58F9BE5D7BB4B062B04E29842D725DF651C93DAB1CB6602DB0CD9117FB468FC7A9DE389FB68FBCC68A6E5804580669A84A16FFCC23826BBA3D777E126E433ED1B598E51F4714C2117F0286ACEDC6C8AC13F61FD098FF6FF7F14BAE5431B93B47896FF5F6E0E08123940B2C13A3CA5CC5D001F1D241B1C6257B94C7555EFE5C1004056FC0794B25A7C2AAB16916FBA0C2BB75C44D67816E00BE44FBBF3506431A593B6901CE85FC4275AB2B4B460D1736A1FF4F5557AE383D50AE33EC96619BBB8F6B2BDADCD12C9F0EDEB37D180AC7AD66DD0941E3C6D529FC02773189CF505004ECAD5E68C6408B624261B4D366186F7C4B9BDBDFB6D5F940A727ACB65D0DE8E6E634C378A3CCD63A022B57A5AD856D7043C22CA4E3EC2AD0540C4DED18B0C9B980FFC7D7B69805D13B40F51CB6EC875E8A3CBD8F5810FD110D4A53A04D9880D44E457495D003E4599C9E4DAE6D7DED770F96EE83033B5C9EDBB9CF6458E822E31DFC3D85C78F2476CAF1C8313089E9829AF4A16301EEC1C76844737406228266082031BE0DCA9BC1A005D763B0B43B59CA3AF299FABD840D5C2DB52E86BE0131DD77861B550264463855E163704E9067631C37928F7FC4A88E785193E7A3E1EAD50F5FBB43812E06C3806B36CACBA231EEFDDF40D5E4A1010ED33ACB2C9AE48F9DE4068138314C7636B4894388AE12CAA5B9F697E19DB838EEA95E9FEA215DEDA67836951FEB83FEC5480CD70D55F95DB6A34310684EE39FEC5805FE784ED529D34D48E156D9A07C2D2B9FA20F77DDA6CB671D2866EA283CE29A2B78B385B83B687D3C94A2A2BFBECBD0A238DC50B779EF99E8E2DF4B534B06A6EDC64947A06E57E8B1A3314FC50B8DC5B39234BF563AB8142C41AC1317BA009EFF40A05D27E2D3B9B143B219179BA51CAD8AB4CDA264C77EE8CF5127E5ACCC453A65401A710A39364770769E9E1A1C4E7162CB79D80398919219F35D76F76A1B7657D97FE42F4110636AA81A6229244BEC3E44AC24399DFBA8314B2EE2A564474A5CD07BF5EA8BBE76338FAD7CDD48D390A55EABB3BCB0F75F2BBA6F99771D0AC85E619138AE748B8912E3CD0E3E67540A0477879656D1F345A06180EE5DF690F66C4F98673C395946123265D3CA78DFFB2B3F44AD6431E1152E5162ECFF3F5DA6372571702C7054A683544362EF2DFC6BCE86C01A58950725F5C2A11E37FDA62E9605D1206BCF0E6A78F1DBCC945865EC05949EA5380276FB1B681694957565CA020C8784B742BC874813802E9126F8A3CC0BAFCF1CBC6AAF4AC5D1D6DA97E7951A3DDD9525528C120ECC85FD322C6020846AA05BB3944C8D2D9FCCCB7D2C26A12107F7719CD859E429EA0F67B83E4A3C700CF56EBF890F6FF676256D29D839267B524FDD580A2B80BCBC67C3D81E287639C6817C94B31EE7DB16021A3DEE9EB63422B88667CB3B392FE81A3D3AF3CECA6B0DF7A99D83250C942E66C74A13311D79C47D212F568CA7AC4A4F19FB927A86F5B03671D7525244DFFF90B599AF08C61C938F21E6312ED8A3F0FEAB2BA0FF85AD2178D45540ECE7FD1AB46DA331A4B81444D09E1979C97446190EE750723611CA4A7D9ABA5F56F4322B15B497200794FBC9EFA6267014530E4B6D9FE1D0E8CE68FA59AEC237DA5148D3ECCAD7FEB8878EC4700FC16B377A3478B917CC7DCC5108DA8FECB990D35F0D9A94DA7BFCCDF73181BBAB730757B139330C1CF18F54650DF7805D02931794D0E6D593CC796355688B60A516ACBE175EF3EDFEA59D63903FDB7A1B9135B1FBE80D6C29CA593AB85FCDEC965A66651C2D699C1330B7283B4C35DCE871FC4C542D6D0B8EA72459F16340F1F3440DC767EEE216D64F31B184421117C94007EE467D987F7C4AFADF21672D203BAAB84BF032C1A2CDB23FF91B17A191C5AE6FC6053896B22FCD54785C80FDA169B887B77E4DFBB95A7F5F855F2195A76502F84C30C52BAFD8009B0A7B699A03296DB75C5DD3B3950DCE91CE9D9E044E479509EA690B3AF0D0E382A31D005F603B1F090ACA22DDC6D62A660B902EE61BB45403D680F8298F3F2F44B3BAC797A9BBF378EF07D8ED8E5F16D51F105318B90442D8025CFE682368CE9A10C464932DE26644F39B59A5EA1B86EABD99F8F9F522F4FD2A2891F564225F9969272143C01FC74031534AE080346240015EE7920D8113AB5F65AAFBE309B34B0CDC6D6B278CBA819E30197DE73A07490F90514CD46ADE65B087478167CD532931C35964ACD6B64F0B447250F0B6C56986184B39D5ABA5E2C5D6E822C5A5F75731DB1B6AF521886EFDB9CB29F0FF62E5C50C4BEF9F234F328A1914E0436410BE52A98E7D8876CEB31C29D9E731819596581EAFEEC807D5403864D2F7DBB83FE513C9B1D499C17DED2B3F199D077D8C7A0CB6369B5E41C4A36C1031D5E548DCAC21C324DB07A85C18C87448C42B9E670B819585C4D489BFB81180C00B0AEF70CC60A9AEC2A6CF86E6675CEB84642BBA6A36A9A3BEA8A9FB1341CD166484053B26B578B9A33DA3EC955576C8079B7D0F5C672C7D0A4081C23E74F24BF80BECAFE970ECD42DD7FFD1169D306BDBD86C620F385F638EC352F0C59E477D60F212F285954230E847AC4C8228DFA368DDC4A3BB03D7895EF91979980B6A4DEF4BB5606C506B24020CF6C9E0840502773D763709D3DF87155F9DE1B517C65FFE321407A35D41AAB3DE508840094160C13E25784C457DDABC064AC22C2403DE4A78752A273AB4DF2DAD601D1C5A7F589AE1EB309076586045F8D94A695983F5615260BF1F5040861BC767EE1083F2C9A0CAA02270AC4FE08F193BBAD31502571DDE92F1DF86AC86B16EADB9E520615684FEB881C3D36B8005DF2AE8BE211DB72F82F39EB9E0C7684F2A130BE15506E7D9A1E6771719B74DC04681BEA6023E51C18751D99F10CDDAAF79B9C96F823226002FEBA0F925CFB743E033B9BE07EA601C7A20699931252EA9D046AB1BFC420314D4AF8C12CD1411C5E2AF6AD0E9F8A5691F7A49030A7EDB7DF91DBCD13C5431F5EA9A40102F0A15049448F8691893E77C1C9B26A3848BFBBC4093DC784447A65ABD45B560A2C75FB3811D9D5C0E226DB195BEE4894957CCB20CFA3ED826501FF7062A58BCE76EED704F0A258B478E86D65EB519C6A0B42F69C236EACDFF4899ADE79A8980752BA54E1BE87208B23F012C8CD591E6084A2C381A5B3CD5C771D9D537611CDAE39DCFEABAA6FA85B456B56E76E7C84C2BA56CE645B563DDC21AE590709FDBBFC3879718538A4712247DFBF48385734F18F9BE598AA4E36F83F4892D9A3501BD6A2C8C180C287627C37F2EDB48FCF72CF57992D72E781327BC65D49CF2B9C08B7D222461E492B909249A3240D018F0CD85C481D5E397A074595498F63D3FBC7F434136F7E387D5750800EB91207BAC573C63C359033709B89D44ED0DF38D8EC00CEC7E56324FA49F98B8C1E94CF3AE8EB84DB7EB4CDE20A5398EAE15B6294354353D1CEAD07595800B512279A5272B09E1325F14FF298FFA9AACFA54D378DBF98E791515FC7927769A450006D94290310079E16E70345188EB5CB4EBABA7CAD33BC4D1CA74027130DA404F7719B1FA188F2207498A4734867A5104A7466E79E243429BB7343F9DF0D27A88719503BC199831C0D3C6995E3A8ABFD5E576B2C64E6FBC25F94EA0691772922903D9E9DD49DBB69DE3940DC5EFBBF1548D4B1D80842F550167FF25A5032F353361E7D097BD1E7554414324B53C9456770DB81EEC1CA117286B2A2BB740FDC9ABB31F20D99954E4418AD5974E99D1377475A9864399F0FB776ACFB11A05E61D19F23E3CC6F6806BE0A0645904468F644598F9CE31EDAB7C2EBD2FE7DA00E3C10CD01071349289DB54ADEC031D826E9D2B41F26D58D9CAFF6F37ACCB197CD46293B9A1A22E525990E4ADAA2D3612407F2878520DCB157825C5419BA88EC5ACE5C5DF032F7397012178976B64BF16E8FD83D6074E934CE5859A81994401F12A7B3B55F9B9F45FC33220066F0B7A32763E48EB0DD52EE4B386BF111795D0E5BE2F913A15B45A392AD68D7DBFC30001ACC4C6AF25BA0A9ABCB7E84A23026EBD70B5E8FA254F7D03A3D0963922823CDD6B750F0C57150FED3F962D1CB92FDE71E5466798FA39EE823858B58E00F8EEF7C9E47B6B6E541258C9AC8BF30DA63CDCDA8BB508D5ED6EC35F1288DAEC7E29BEB9C32561E835635C4FC56136A5A03403B55881A11B90754AFE995004A548D58F91066C5CFDC2405C5A4AF4492AC289B9F6FBFB941B6BAC19146C758DB42F2EC6DE8A746DBF665F453C03EB2B5369908CBF8D587EEEC87381B3DD00321827430A4498A3197C4C680BA30ED39A4DE9B202A95E51FED48B5CC330A91F1985F178FB5B952440D48379F20F5E9CCE78F6EE299D34A4679837AE84B3B3A495357B0426DAAE670E3C05A0A9FDFB1AC16D2E5476807D927BC53FE31094E787765DEB744964FC9F04D5956435BF15850698C08BF0C8006036D2562A6C2E6360E7A74426EFDDE3420AD4B53DAA6119F935E1E24CB45CE2D6AB802AE53515C7EDE06036CF5020198D92E53817B71A37F7E130ECE4BE51FAC3F310722C5BCE2192292C92F68E589DFED041E4D4FF0D3DE220C3A4B60D699E76261473499983D2D4E56BB47637868ED8FD6272C747731383A5979AB70C5FFB4669F2293AD050BFDDB8B80F001CD46CA2AA8FA8396C671686677B0EF0546B050C0B761333251A67FC740DF69678C5B8A826ABBEE72EF229FBDB6E5C00BB89D8A4B0ED2C19F513AA225C88AC116A717279F3FD3582D00AACD5BD6A9897AD661A7091B7200797669F65F0E3D09DB4460F6749E85F2E7BA5576E66C576FCE30891D4C347BDCDEE97718054091A38DA11F10AACB041037D13C301B6BA7D885C92AABB99FBC46CCFA406513C5E8736813F46BD8EE0368F5240632F8CD8EB29ABB223100D4CDD9B2DF42B5A6DB024C02A95802009E1AF538195E47BD051B5E097A453463C31E445228E1942CFE0A25039DA3C949BC9AE41428F39CE0A7A78430DD1E5D1F6C83A09BD4063510CB02736472B8BC203933045FC4BF6F38BEB4FFC5671F2AB5992A4B9A69CD9F7C14EE116CDF10415212085B98EA06F1C261AF748B0CA78D07BD032DB93F36F4541931C6818BA023BE9CEB4EE6B7B9B5B7554CC7822DD36C22AE6532B87C2F772DFF6D6F7916191A76C8376AA83A0DF2AB875D973B39FBB05B7BC8617E4316557D6BC076354577B12EB5EE5A5FD07D3E437CA3233E4235AA4D087624151955BF4B4E4259F12E9D7F6F794190BC469754941E8A9437F3A55AB73789B016B15F4E95FCAC2734ED61712AF1004FDDDBF87FEAC7F0848B77334AAE4306DE145ED0BFDA1956BFADEA373E9F8DB70109AC97F0BF861C5759594B439BD0B5C1FC1E5EA9B4CDB6525C769F542DF7AE0CC88D9075BEC446C15B8DB2E6E08888E2EA9F8BD50E81146375C1515A9F1ACFC2E47781B3FD901BF0561AFA3686F6C1835AA45354FF5BBD048BC5903EDB946C92619A698EB5B53ED36D48ECEC87573718E12C38FEDBB6911C294C84CA04015561A54C58CF8B7531E300661CA33C692F94965548224ADF414E738CD739AA1FDA26199779BE1BF3DED8A9A7AD6D18E2FDDA6BC30B31453963E4808847D77B0CA9BC9E0F79C864D32697332F5BDD1EDD1E39FFCC2F57ED1BCC14F25A83214AD5A8D1253BBF8AB4A049E2C0B323CE36D29B45CD56D0E48F6BE64B77B110316081F3A71F462507A494DAA8CECA17ABC9274E0BC95DD88FBD9D1520E177D0F633720C00E1F48C6FDAC4CED7B672C6D96759D9ED3CDD1164810E26D3AC999DAA69AF7D686CD2D8AA56153E57764D063AD719D6766C188007F683243F1209387CF6F718869B5E05DC625BEED120258A1C3E0F9D971AA366B163EE27F3FB0945991D7C86ABD31D0721862C02971C339289CE76B23A1CB329D2859BD8404A3FF5CE3E9AF8F79FDE9583892818FCE0E0138835205E6DB52C4F2F35EF78273A54CC080DA95CF0BBE42B6243D4F35F8FBD726C4816405B30BB9E959D2B45D951AD467662DDDD4D35D5526C37DE5B8CE720C5C3066C908F6E12F8560A48366C4A2F6B45BFBF34EA536E3EE5B1B10D7C899AA319C8D1DC72034414EB25425ED30F25F4E634680014B0CBF2F193226106E94866C613F41E2E6F56E611EA24C855DF75DF44B5E12F801D70CD28D6B2284DE914FCBDEA82F2FAEA2064C15CB30D7A351861122550F03F75DC0C22BC759074A2B86E6F119CC881200DFF72D5E18CAAD1724C5BA83C5C6D3A164F3CBF212CF7812703C82516AB361B01B87A29A3DDAFBED279A2B1EDD112C177633293380FB401063CDF9D963E71E95E0CCD060AE75606D94FA51D896E410B1D93365DCDDB21253011EC3754C517F011F03BAB2094E84D9A0B4499A8A8E7FBB3AED855AB7776D0D41CED09B9756EFBCE67886C43CA763270C94F844D88CED855931EFC994E2696459351804C1B58CD5E437FF9CA1CDCC535A278486FC5EC4DD9466EF1F93ED2EAEEE9B11444AA9A942FA0A12462108E209F645D9BEBB5CE058384C37E3A88E7B0018BF3B7B1F0D4E5714E3518D3B8D9F9970D125F4D4B31170592D59749973200F1840940F3526B304B1527354163C4C3E5A795CD76E189C694D174FE6D850845AE385247A7014C9ECB8BBD271F61C0BB56CFEB4D8705FBB130280F466E25A1FAECD5E73232E27B14499D6EB20C4F64D23028F2A4C3A2E184FC3478937C32F01EFF8610E50F6444287C76CE2027D995C4D125CFC9D6927566937293135DCAC4A3A5FA9061D335787F7187CFBAEB5D7D21C30732D97A58088479C7974F11BEBB05392FE708CF9323FF3977B22D38C8B2077413F05B29AB9B8608F92C05A33E2FC638AFDE6A137C85C15C12564E4B16D0964EBCE8E7E9E406288EA5DE3F486018D071E02048FD978842852FF745F61F72484EC241817AB2DF6887F4393A1DE63D3ACFDEDECEFB75993E914CD279978025DD7DF63B5A4A4E0598EBC27E6F81521D5424CF6C31761C7179A4F4EF81E035D74D3219CBEF31A3C64608341DA314FA7AC372FB1316D0F29D362C5DC85A7E30F7CCAD15F4C18F969646DBD4CCE9A6AF305C7EF8CE5D65EF43C8670060F937AAA5EA12906C022D59398A4760607A2C4F6A39887B30F389304FF6260D0FEFB6B7F54D6A5B43BE4D1BCB72089EE2D6E7C76DBAEB21EE4FC8120794665155B57E7606ED7B7D926C344F767A22302CB06C53617A5E0491EB7701A3D0F745E55A5121510A9FCC1AC9F9184C7DAB481D20C0353543E9F8079CA7A4D929FEBA5BD317B6D72DC31563BC8EE09E68505DC1603B939A34358413729505CF31F26B289E4ADA61FD662DD07FE02E949558B87CF2684E1ABB27C8D9D205FFD8D11001754225977766408D487898FF769AA3EEA1AD8AB72253C77497435BB50C4303F79DC3C9A002CA61486F65E984533217D6F769205CF5F120000891053B4AE270362847358A3C840251FD352BC5D86EAC29248752F18BA07AC752D7B474B9610AACBD083CF9826E75551615EAF6FB8F644F5575C63922CFDD07AB56B75757AC8D294EBC9AB0EF52F6D8828F4082112F0B58B50886408BFA01953FB2185448E11673124F1597139BC5DDC7264D8544F05C09043D74923107C62DBDB531094B785D7446C346C81C9AD559BCF51B1162184FD2F248D26FFD152BA4FB769B1CA1159F34BDA2E37CBD26DD650913522FAAC437ACC4BACD3A347D19F34F4CA0D726AEC0520273C081A52C38EA451F4C6AB09DF075DF4DD5BEFCC8AD66F7B3A2DC4C42F24E83369978A9E39F14868826925C5BFEE97C0EACBED4E486D0E3943B004D7D4D3007EF496F2DCD6C0767798E2F25FF8C58E32C36990CFA6CF8E9FB4B7FC8C51767DAF5E826D8A220E20E077AC39CDEE7BEA33189434E305FDC6222F8F3883B2212A110B0F01F57B5E1A4ABF59C1F7D6D92E8F83CC7035C63EA8BCC06CB68E3DD15F1170E075C3C0F7FC204F620F3BFD0B4C7640AE2C02D8F7326991D78D34E41790C1D761B36A438A55133EF8C4E8E0F84BFC73D31E9C9967E6AB9F87B72F86BE2858B0E727B611B32294DDD6D1C31E71189905EB69E8057AD9078DD085EE03F852B06C7A08478B10395BCE3DBB852B822EA9078138E032FF72867AE98D1421151DC7F4EC7D1048E354E3248A2A5ADE7592ECAF3BE51320E46835F5A3BAF736E2D03EA62027D94E751FEB9D1F3363CB487F08E08E7320D54647A5F2630122B71894DDE498B2BE9BC15CF6E29343356EA11B023E28DB3ED07F416BDD6ABAD37D8EF30D3BC0B3AFF615CBCCDE4D82582492F5C9DC95EEB7C47A78A1B1C7ED7DF40CA55C0A8142EE19A9FBF7210B6ACAF7AF25AB74E97369A9F83263297EFE4804FA9EFDCB136694285F90".substring(0, 4816));//fromFile(50);
        Matcher matcher = new Matcher();
        long startTime = System.currentTimeMillis();
        SuffixTrie suffixTrie = new SuffixTrie(matcher);
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        Coder packer = new Coder(new BufferedOutputStream(out));
        int lastWrite = -1;
        for (int i = 0; i < bytes.length; i++) {
            byte b = bytes[i];
            suffixTrie.insertByte(b, i);
            if (matcher.hasMatch()) {
                MatchInfo latestMatch = matcher.getMatch();
                packer.writeMatchedBytes(latestMatch, i);
                if (matcher.getState() == Matcher.State.IDLE) packer.writeUncompressedByte(b);
                lastWrite = i;
            } else if (matcher.getState() == Matcher.State.IDLE) {
                while (lastWrite < i) {
                    packer.writeUncompressedByte(bytes[++lastWrite]);
                }
            }
        }
        matcher.finish();
        if (matcher.hasMatch()) {
            MatchInfo latestMatch = matcher.getMatch();
            packer.writeMatchedBytes(latestMatch, bytes.length - latestMatch.getMatchLength());
        } else {
            while (lastWrite < bytes.length - 1) {
                packer.writeUncompressedByte(bytes[++lastWrite]);
            }
        }

        System.out.printf("Finished building tree in %d ms\n", System.currentTimeMillis() - startTime);
        System.out.println("COUNT: " + Node.COUNT + ", bytes: " + (humanReadableByteCountSI(bytes.length)));
        System.out.println("MATCHER: " + matcher);

        packer.close();
        byte[] compressed = out.toByteArray();
        String s = toByteString(compressed);
        System.out.printf("COMPRESSED (%d): %s\n", s.length() / 2, s);
        decode(bytes, compressed);
//        testTrie(bytes, suffixTrie);

    }

    private static void log(String format, Object... opts) {
        System.out.printf(format, opts).println();
    }


    static byte lastBoundary = 0;
//    private static int encodeBytes(byte[] bytes, int posInStream, Match m) {
//        int matchIndex = m == null ? -1 : m.getMatchIndex();
//        int encoded = 0;
//        byte[] a;
//        if(matchIndex == 0) {
//            OUTPUT.append("(1,")
//                    .append("-").append(m.getRelativePos())
//                    .append(",").append(m.getLength()).append(")");
//
//            int val = 1 << 22; // shift 22 bits to fit other fields
//            val |= (m.getRelativePos() & 0xFFFF) << 6; // shift 6 bits to fit size
//            val |= m.getLength() & 0x3F;
//
//            int shiftBy = (1 + ((8 - lastBoundary) % 8)) % 8;
//            val <<= shiftBy; //boundary align
//
//            byte[] byteVals = new byte[] {
//                    (byte) (val >> 24),
//                    (byte) (val >> 16),
//                    (byte) (val >> 8),
//                    (byte) (val)
//            };
//            if(shiftBy == 0) byteVals[1] = (byte) (byteVals[1] | COMPRESSED.pop());
//            else if(shiftBy > 1) {
//                byteVals[0] = (byte) (byteVals[0] | COMPRESSED.pop());
//                COMPRESSED.push(byteVals[0]);
//            }
//            COMPRESSED.push(byteVals[1]);
//            COMPRESSED.push(byteVals[2]);
//            COMPRESSED.push(byteVals[3]);
//
//            lastBoundary = (byte) ((7 + lastBoundary) % 8);
//
//            encoded += m.getLength();
//        } else {
//            int start = encodedLength - posInStream;
//            int end = bytes.length <= Compressor.MIN_MATCH - 1 ? bytes.length : bytes.length - Compressor.MIN_MATCH + 1;
//            for (int i = start; i < end && i != matchIndex; i++) {
//                if(i > matchIndex && matchIndex > 0) throw new RuntimeException("index > matchIndex");
//                OUTPUT.append("(0,'")
//                        .append(String.format("%02X", bytes[i]))
//                        .append("')");
//                a = new byte[]{
//                        (byte) ((byte) (bytes[i] >> (1 + lastBoundary)) & (0x7F >> lastBoundary)),
//                        (byte) (bytes[i] << (7 - lastBoundary))};
//
//                if(lastBoundary != 0) a[0] = (byte) (COMPRESSED.pop() | a[0]);
//
//                lastBoundary = (byte) ((1 + lastBoundary) % 8);
//                COMPRESSED.push(a[0]);
//                COMPRESSED.push(a[1]);
//                encoded++;
//            }
//        }
//        if(m != null) m.recycle();
//        return encoded;
//    }

    private static void decode(byte[] input, byte[] compressed) throws IOException {
        ByteArrayOutputStream os = new ByteArrayOutputStream();
        String string = new Decoder(compressed, new BufferedOutputStream(os)).withDebug(input).decode().getStringRepresentation();
        os.close();
        byte[] uncompressed = os.toByteArray();
        System.out.printf("Required %s bytes to compress %s\n", humanReadableByteCountSI(compressed.length), humanReadableByteCountSI(input.length));
        String inputStr = toByteString(input);
        System.out.println("INPUT:        " + inputStr);
        System.out.println("COMPRESSED  : " + string);
        String s = toByteString(uncompressed);
        System.out.println("UNCOMPRESSED: " + s);
        if (!s.equals(inputStr)) throw new RuntimeException("Not equal");
    }
}
